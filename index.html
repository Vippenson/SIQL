<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>SIQL</title>
  </head>
  <body>
    <link rel="stylesheet" href="tabulator.css">
    <script type="text/javascript" src="tabulator.js"></script>
    <script type="text/javascript" src="parser.js"></script>
    <script type="text/javascript" src="jsDump.js"></script>
    <script type="text/javascript" src="jquery-3.6.0.min.js"></script>
    <script>
      function openByName(name) {
          var o = document.getElementById(name);
          if (!(o.innerHTML.substring(0,3) === "[-]")) {
              open(o);
          }
      }
      var exampleModel =
          { query:  'DefaultInventory         = [ text is "B2525 Fixer" & kind is WEAPON x 1, kind is MISC x all ];'
            +'\n'+  'NewStuff1                = [ exclude  DefaultInventory , everything ];'
            +'\n'+  'DefaultInventoryWeapons  = [ text is "B2525 Fixer" & kind is WEAPON x 1 ];'
            +'\n'+  'DefaultInventoryMiscs    = [ kind is MISC x all ];'
            +'\n'+  'DefaultInventory2        = [ DefaultInventoryWeapons , DefaultInventoryMiscs ];'
            +'\n'+  'NewStuff2                = [ exclude  DefaultInventory2 , everything ];'
            +'\n'+  'DefaultInventoryWeapons2 = [ "B2525 Fixer" & kind is WEAPON x 1 ];'
            +'\n'+  'DefaultInventoryWeapons3 = [ "B2525 Fixer" & WEAPON x 1 ];'
            +'\n'+  'DefaultInventoryWeapons4 = [ "B2525 Fixer" & WEAPON ];'
            +'\n'+  'DefaultInventoryWeapons5 = "B2525 Fixer" & WEAPON ;'
            +'\n'+  'DefaultInventoryWeapons6 = "B2525 Fixer";'
            +'\n'+  'DefaultInventory3        = [ "B2525 Fixer" , MISC x all ];'
          , inv: [ {text: "B2525 Fixer",  kind:"WEAPON"    , quantity:2}
                 , {text: "Key1",         kind:"MISC"      , quantity:2}
                 , {text: "Key2",         kind:"MISC"      , quantity:1}
                   , {text: "Spoiled Meat", kind:"FOOD_WATER", quantity:11} ]
          , selectedQueryIndex: 1
          , actionBindings: [{hotkey:49,action:"transfer",query:"NewStuff1"}]
          };
   </script>
    <!-- ------------------------------------------------------------ -->

    <center><h1>Standard Inventory Query Language</h1></center>
    <p>Here is a simple query language that I (Vippenson) developed to express basic queries on a table of items with quantities.
      It addresses almost all my personal needs to automate different processes and routines.
      Once one selects/filters out items using queries, batch actions can be performed on all items in the resulting views.
      Below, you can find
      <ul>
        <li> some simple <a style="text-decoration: underline" onClick="openByName('queries')">queries</a>,</li>
        <li> an example FO76 <a style="text-decoration: underline" onClick="openByName('inventory')">inventory</a>,</li>
        <li> the resulting <a style="text-decoration: underline" onClick="openByName('view')">view</a>,</li>
        <li> the generated <a style="text-decoration: underline" onClick="openByName('configs')">query configs</a>, and</li>
        <li> a <a style="text-decoration: underline" onClick="openByName('configs')">tool</a> to generate configs that binds hotkeys to batch actions on the result of chosen queries.</li>
      </ul>
      The page can be used offline and every section can be edited and played with; you can define your own example inventory, queries and generate the views and configs in the browser.
      If you have suggestions/comments, you can find me at <a href="https://discordapp.com/users/vippenson#1486/">vippenson#1486 @ Discord</a>.
    </p>

    <br> <!-- ------------------------------------------------------------ -->

    <div>
    <label>Load from GitHub Gist: </label>
    <input id="queryGist" type="text"></input>
    <label>Gist Filename: </label>
    <input id="queryGistFile" type="text"></input>
    <button type="button" onClick="loadQueryGist()">load</button>
    </div>

    <br> <!-- ------------------------------------------------------------ -->

    <fieldset>
      <legend id="queries" style="font-weight: bold" onClick="collapse(this)">[+] SIQL Queries</legend>
      <div style="display:none">
        <a id="show" style="text-decoration: underline; display:block;" onClick="collapse(this)">[+] SIQL syntax</a>
        <div id="grammar" style="display: none">
        <img id="Syntax" src="Syntax.png" style="height:300px"/>
        <br>
        <img id="SyntacticSugar" src="SyntacticSugar.png" style="height:200px"/>
        <br>
        <a href="fields.html">[Supported Item Fields]</a>
        <br>
        <a href="modes.html">[Supported Comparison Modes]</a>
        <br>
        <a href="kinds.html">[Kinds and Their Patterns]</a>
        </div>
        <br>
        <br>
        <textarea id="query" style="width: 100%" rows="30"></textarea>
        </div>
    </fieldset>

    <br> <!-- ------------------------------------------------------------ -->

    <fieldset>
      <legend id="inventory" style="font-weight: bold" onClick="collapse(this)">[+] Example Inventory</legend>
      <div style="display:none">
        <div>
          <button id="addRowInv" onClick="inputTable.addRow({})">Add</button>
          <button id="clearInv" onClick="inputTable.clearData()">Clear</button>
        </div>
        <div id="inputTable"></div>
      </div>
    </fieldset>

     <br> <!-- ------------------------------------------------------------ -->

    <fieldset>
      <legend id="view" style="font-weight: bold" onClick="collapse(this)">[+] Example View</legend>
      <div style="display:none">
        <div>
          <label>Query Name: </label><select type="text" id="queryName" value="DefaultInventory"/></select>
          <button onclick="runQuery()">Run Query</button>
        </div>
        <div id="outputTable"></div>
      </div>
    </fieldset>

    <br> <!-- ------------------------------------------------------------ -->

    <fieldset>
      <legend id="configs" style="font-weight: bold" onClick="collapse(this)">[+] Query Configs</legend>
      <div style="display:none">
        <button onclick="parse();populateQueryNames()">Generate Config</button>
        <a style="text-decoration: underline" href='https://www.jsonschemavalidator.net/s/cRcD4uem'>[Validate JSON Here]</a>
        <textarea id="config" style="width: 100%" rows="10" readonly></textarea>
      </div>
    </fieldset>

    <br> <!-- ------------------------------------------------------------ -->

    <fieldset>
      <legend id="actionConfigs" style="font-weight: bold" onClick="collapse(this)">[+] Action Configs</legend>
      <div style="display:none">
        <div>
          <button id="addRowAction" onClick="actionTable.addRow({})">Add</button>
          <button id="clearAction" onClick="actionTable.clearData()">Clear</button>
          <a style="text-decoration: underline" href="https://www.makeflashgames.com/resources/keycodes.php">[keycodes]</a>
          <a style="text-decoration: underline" href="https://www.jsonschemavalidator.net/s/LjhEceNX">[validate bindings JSON here]</a>
        </div>
        <div id="actionTable"></div>
        <br>
        <input type="checkbox" id="forStash" name="Embed in IOM-Stash Config" checked>
        <button onclick="generateActionConfigs()">Generate Action Configs</button>
        <textarea id="actionJSON" style="width: 100%" rows="10" readonly></textarea>
      </div>
    </fieldset>

    <br> <!-- ------------------------------------------------------------ -->

   <fieldset>
     <legend id="pageData" style="font-weight: bold" onClick="collapse(this)">[+] Saving Page Data</legend>
     <div style="display:none">
       <button onclick="getState()">save page data</button>
       <br>
       <label>Page Data JSON (for Gist):</label>
       <textarea id="state" style="width: 100%" rows="10" readonly></textarea>
     </div>
   </fieldset>

    <!-- ----------------------------------------------------------------- -->

    <script type="text/javascript" src="index.js"></script>
    <script>
      function getState() {
          var currentModel =
              { query             : document.getElementById("query").value.replace(/(\r\n|\n|\r)/gm,"\\n")
              , inv               : inputTable.getData()
              , selectedQueryIndex: document.getElementById("queryName").selectedIndex
              , actionBindings    : actionTable.getData()
              };
          document.getElementById("state").value = jsDump.parse(currentModel);
      }
      var inputTable = new Tabulator("#inputTable", {
          data: [],
          layout:"fitColumns",
          addRowPos:"bottom",
          resizableRows:true,
          columns:
            [ {title:"Text", field:"text", editor:"input"}
            , {title:"Kind", field:"kind", editor:"select", editorParams:{values:["POWER_ARMOR", "WEAPON", "ARMOR", "APPAREL", "FOOD_WATER", "AID", "NOTES", "HOLO", "AMMO", "MISC", "MODS", "JUNK"]}}
            , {title:"Quantity", field:"quantity", editor:"input", validator:["min:1", "max:1000000", "integer"]}
              , {formatter:"buttonCross", width:40, align:"center", cellClick:function(e, cell){
                  cell.getRow().delete();
                }}
            ]
      });
      var outputTable = new Tabulator("#outputTable", {
          data: [],
          layout:"fitColumns",
          addRowPos:"bottom",
          resizableRows:true,
          columns:
            [ {title:"Text", field:"text"}
            , {title:"Kind", field:"kind"}
            , {title:"Quantity", field:"quantity"}
            ]
      });

      var actionTable = new Tabulator("#actionTable", {
          data: [],
          layout:"fitColumns",
          addRowPos:"bottom",
          resizableRows:true,
          columns:
          [ {title:"Hotkey", field:"hotkey", editor:"input",validator:["min:1", "max:1000", "integer"]}
            , {title:"Action", field: "action", editor:"select", editorParams:{values:["transfer", "drop", "consume"]}}
            , {title:"Query", field: "query", editor:"select", editorParams:{values:[]}}
            , {formatter:"buttonCross", width:40, align:"center", cellClick:function(e, cell){
               cell.getRow().delete();
              }}
            ]
      });

      function loadQueryGist() {
          jQuery.get('https://api.github.com/gists/'+document.getElementById("queryGist").value, function(data) {
              try{
                  var model = JSON.parse(data.files[document.getElementById("queryGistFile").value].content);
                  initialise(model);
              } catch (error)
              {
                   initialise(exampleModel);
              }
           });
      }

      function buildErrorMessage(e) {
         return e.location !== undefined
             ? "Line " + e.location.start.line + ", column " + e.location.start.column + ": " + e.message
             : e.message;
      }

      function tryGist() {
          var param = window.location.search;
          if (param.length > 1)
          {
              try {
              var tailParam = param.slice(1)
              var params    = tailParam.split('&');
              var gist     = params[0];
              var gistFile = params[1];
              document.getElementById("queryGist").value = gist;
              document.getElementById("queryGistFile").value = gistFile;
              loadQueryGist();
              }
              catch (error) {
                  initialise(exampleModel);
              }
          }
          else {
              initialise(exampleModel);
          }
      }

      function parse() {
         try {
             var output = parser.parse(document.getElementById('query').value);
             document.getElementById('config').value = jsDump.parse(output);
         } catch (e) {
             document.getElementById('config').value = buildErrorMessage(e);
         }
      }

      function runQuery() {
          var name                   = document.getElementById("queryName").value
          var inputData              = inputTable.getData();
          var inputDataFixed         = inputData.map(item => ({text: item.text, kind: item.kind, quantity: parseInt(item.quantity)}));
          var configText             = document.getElementById('config').value;
          var config                 = JSON.parse(configText);
          var outputData             = PS["Main"].evaluateCheckedConfig (config)(name)(inputDataFixed);
          outputTable.setData(outputData);
      }

      function populateQueryNames () {
          var configText = document.getElementById('config').value;
          var config     = JSON.parse(configText);
          var names      = config.nameCheckedTree.map(d => d.name);
          actionTable.columnManager.columnsByField.query.definition.editorParams.values = names;
          var select     = document.getElementById('queryName');
          select.options.length = 0;
          names.forEach(n => select.options[select.options.length] = new Option(n, n));
      }

      function lookup(name) {
          var configText = document.getElementById('config').value;
          var config = JSON.parse(configText);
          var matchingDefs = config.nameCheckedTree.filter( d => d.name == name);
          if (matchingDefs.length == 1) {
              return matchingDefs[0].querys;
          } else {
              return []
          }
      }

      function generateActionConfigs() {
          var hotkeyBindings = actionTable.getData();
          var bindings = [];
          hotkeyBindings.forEach(o => bindings.push(
                                        { hotkey: o.hotkey
                                        , action: o.action
                                        , query: lookup(o.query)
                                        }));
          if (document.getElementById("forStash").checked)
          {
              document.getElementById('actionJSON').value =
                  jsDump.parse(
                      { bindings: bindings
                      , debug: false
                      , additionalItemDataForAll: false
                      , verboseOutput: false
                      , apiMethods:[]
                      }
                  );
          } else {
              document.getElementById('actionJSON').value = jsDump.parse({bindings: bindings});
          }

      }


      function open(o) {
        o.innerHTML = "[-]" + o.innerHTML.substring(3,o.innerHTML.length);
        o.nextElementSibling.style.display = "block";
      }

      function close(o) {
          o.innerHTML
                  = "[+]" + o.innerHTML.substring(3,o.innerHTML.length );
          o.nextElementSibling.style.display = "none";
      }


      function collapse(o) {
          if (o.innerHTML.substring(0,3) === "[-]") {
              close(o);
          } else {
              open(o);
          }
      }

      function collapseAll() {
          collapse(document.getElementById("queries"));
          collapse(document.getElementById("inventory"));
          collapse(document.getElementById("view"));
          collapse(document.getElementById("configs"));
          collapse(document.getElementById("actionConfigs"));
      }

      function initialise (model) {
          document.getElementById('query').value        = model.query;
          openByName('queries');
          //document.getElementById("query").style.height = document.getElementById("query").scrollHeight + "px";
          inputTable.setData(model.inv);
          parse();
          populateQueryNames();
          document.getElementById("queryName").selectedIndex = model.selectedQueryIndex;
          runQuery();
          actionTable.setData(model.actionBindings);
          generateActionConfigs();
      }
    </script>
    <script>
      tryGist();
    </script>
  </body>

</html>
